# Local production simulation nginx config
# Usage: nginx -c /path/to/thinktank-ai/docker/nginx/nginx.local-prod.conf
#
# Serves the pre-built frontend from dist/renderer/ and proxies
# /api/* to the backend services running natively on localhost.
# This replicates the production deployment on your local machine.
#
# Prerequisites:
#   - Frontend built: cd frontend && pnpm build
#   - Gateway running on :8001
#   - LangGraph running on :2024
#
# Start:  nginx -c $(pwd)/docker/nginx/nginx.local-prod.conf
# Stop:   nginx -c $(pwd)/docker/nginx/nginx.local-prod.conf -s quit
# Reload: nginx -c $(pwd)/docker/nginx/nginx.local-prod.conf -s reload

events {
    worker_connections 1024;
}

pid /tmp/thinktank-nginx-prod.pid;

http {
    # IMPORTANT: include mime.types so .js/.css files are served
    # with the correct Content-Type headers.
    # Homebrew nginx (Apple Silicon):
    include /opt/homebrew/etc/nginx/mime.types;
    # Homebrew nginx (Intel Mac) — uncomment if the above doesn't work:
    # include /usr/local/etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    access_log /dev/stdout;
    error_log /dev/stderr;

    # Rate limiting zones (mirrors production)
    limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/m;

    server {
        listen 2026;
        server_name localhost;

        # Security headers
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options DENY always;
        add_header X-XSS-Protection "1; mode=block" always;

        # ── Auth endpoints (stricter rate limit) ──────────────
        location /api/auth/ {
            limit_req zone=auth burst=5 nodelay;
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── LangGraph API (SSE streaming) ─────────────────────
        location /api/langgraph/ {
            limit_req zone=api burst=20 nodelay;
            rewrite ^/api/langgraph/(.*) /$1 break;
            proxy_pass http://127.0.0.1:2024;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection '';

            # SSE/Streaming — must disable buffering
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header X-Accel-Buffering no;

            # Long timeouts for agent execution
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;
            chunked_transfer_encoding on;
        }

        # ── Upload endpoint (large body) ──────────────────────
        location ~ ^/api/threads/[^/]+/uploads {
            limit_req zone=api burst=10 nodelay;
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 100M;
            proxy_request_buffering off;
        }

        # ── Gateway API (all other /api/*) ────────────────────
        location /api/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Health check ──────────────────────────────────────
        location /health {
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        # ── API docs (gateway) ────────────────────────────────
        location /docs {
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://127.0.0.1:8001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        # ── Frontend (static files + SPA fallback) ────────────
        # Serves the pre-built Vite output.
        # IMPORTANT: Update this path if your project is in a different location.
        location / {
            root frontend/dist/renderer;
            try_files $uri $uri/ /index.html;

            # Cache fingerprinted assets aggressively (1 year)
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }
    }
}
